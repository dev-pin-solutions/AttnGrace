{% assign bundles = section.blocks %}

{% if bundles == blank and product.metafields.custom.product_bundles.value != blank %}
    {% assign bundles = product.metafields.custom.product_bundles.value %}
{% endif %}

{% if bundles != blank %}
    <div id="shopify-section-product-bundles">
        <div class="bundles-wrap">
            <h2>{{ section.settings.bundles_heading }}</h2>
            <div class="bundles-container">
                <div class="bundles-cards">
                    {% for block in bundles %}
                        {% assign bundle = block.settings.bundle %}
                        {% assign subscribeBundle = bundle.pdp.value %}
                        <div class="bundle-card" data-bundle="bundle-{{ forloop.index }}">
                            {% if bundle.image %}
                                <a {% if subscribeBundle %}href="{{ subscribeBundle.url }}"{% endif %} class="bundle-image">
                                    <img src="{{ bundle.image | image_url }}" alt="{{ bundle.title }}">
                                </a>
                            {% endif %}

                            {% if bundle.title %}
                                <div class="bundle-title">{{ bundle.title }}</div>
                            {% endif %}

                            {% assign bundle_titles = "" %}
                            {% assign bundle_total_price = 0 %}
                            {% assign product_ids = "" %}

                            {% if bundle.product.value %}
                                {% for bundle_product in bundle.product.value %}
                                    {% assign bundle_titles = bundle_titles | append: bundle_product.title %}
                                    {% assign bundle_total_price = bundle_total_price | plus: bundle_product.price %}
                                    {% assign variant_id = bundle_product.variants.first.id %}
                                    {% assign product_ids = product_ids | append: variant_id %}

                                    {% unless forloop.last %}
                                        {% assign bundle_titles = bundle_titles | append: ", " %}
                                        {% assign product_ids = product_ids | append: "," %}
                                    {% endunless %}
                                {% endfor %}
                            {% endif %}

                            <div class="bundle-description">{{ bundle_titles }}</div>
                            <div class="bundle-price">{{ bundle_total_price | money }}</div>

                            {% if subscribeBundle != blank %}
                                <div class="subscription">
                                    {% assign float_variant_price = subscribeBundle.variants.first.price | times: 1.0 %}

                                    <select name="frequency" id="frequency" class="select-frequency rc_select rc_select__frequency styled replaced">
                                        {% for selling_plan_group in subscribeBundle.selling_plan_groups %}
                                            {% assign selling_plans = selling_plan_group.selling_plans | sort: "name" %}
                                            {% for selling_plan in selling_plans %}
                                                {% for price_adjustment in selling_plan.price_adjustments %}
                                                    {% assign selling_plan_discount = price_adjustment.value | times: 1.0 %}
                                                    {% assign selling_plan_discount_percentage = selling_plan_discount | divided_by: 100 %}
                                                    {% assign selling_plan_discount_amount_off = float_variant_price | times: selling_plan_discount_percentage %}
                                                    {% assign label_variant_price = float_variant_price | minus: selling_plan_discount_amount_off %}
                                                {% endfor %}

                                                {% assign selected = '' %}
                                                {% if selling_plan.name contains "4 week" %}
                                                    {% assign label_delivery_frequency = "Every 4 Weeks" %}
                                                    {% assign selected = 'selected="selected"' %}
                                                    {% assign default_selling_plan = selling_plan.id %}
                                                {% elsif selling_plan.name contains "6 week" %}
                                                    {% assign label_delivery_frequency = "Every 6 Weeks" %}
                                                {% elsif selling_plan.name contains "8 week" %}
                                                    {% assign label_delivery_frequency = "Every 8 Weeks" %}
                                                {% elsif selling_plan.name contains "12 week" %}
                                                    {% assign label_delivery_frequency = "Every 12 Weeks" %}
                                                {% endif %}

                                                {% if label_delivery_frequency != blank %}
                                                    <option class="recPrice" value="{{ selling_plan.id }}" {{ selected }}>{{ label_delivery_frequency }} - {{ label_variant_price | money }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                    </select>

                                    <input type="hidden" name="selling_plan" value="{{ default_selling_plan }}">
                                    <input type="hidden" id="unit_type" name="unit_type" value="{{ unit }}"/>
                                    <input type="hidden" id="id" name="id" value="{{ subscribeBundle.variants.first.id }}"/>
                                    <input type="hidden" id="product_id" name="product_id" value="{{ subscribeBundle.id }}"/>
                                    <input type="hidden" id="basePrice" name="basePrice" value="{{ subscribeBundle.price | money_without_currency }}"/>
                                    <input type="hidden" id="discPrice" name="discPrice" value="{{ subscribeBundle.variants.first.metafields.subscriptions.discount_variant_price }}"/>
                                </div>
                            {% endif %}

                            <script type="application/json" class="selling-plan-map">
                                {
                                {% for bundle_product in bundle.product.value %}
                                    {% assign variant = bundle_product.variants.first %}
                  "{{ variant.id }}": {
                    "available": {{ variant.available | json }},
                    {% assign entries = "" %}
                                    {% for group in bundle_product.selling_plan_groups %}
                                        {% for plan in group.selling_plans %}
                                            {% assign frequency_label = '' %}
                                            {% if plan.name contains '4 week' %}
                                                {% assign frequency_label = 'Every 4 Weeks' %}
                                            {% elsif plan.name contains '6 week' %}
                                                {% assign frequency_label = 'Every 6 Weeks' %}
                                            {% elsif plan.name contains '8 week' %}
                                                {% assign frequency_label = 'Every 8 Weeks' %}
                                            {% elsif plan.name contains '12 week' %}
                                                {% assign frequency_label = 'Every 12 Weeks' %}
                                            {% endif %}
                                            {% if frequency_label != blank %}
                                                {% assign entry = '"' | append: frequency_label | append: '": ' | append: plan.id %}
                                                {% assign entries = entries | append: entry | append: ',' %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                    {% assign entries = entries | strip | replace_last: ',', '' %}
                                    {{ entries }}
                  }{% unless forloop.last %},{% endunless %}
                                {% endfor %}
                                }
                            </script>

                            <button class="bundle-button" data-products="{{ product_ids }}" onclick="addBundleToCart(this)">
                                ADD BUNDLE TO CART
                            </button>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
{% endif %}



<script>
    function addBundleToCart(button) {
        const bundleCard = button.closest('.bundle-card');
        const frequencySelect = bundleCard.querySelector('.select-frequency');
        const selectedOption = frequencySelect.options[frequencySelect.selectedIndex];
        const selectedFrequencyLabel = selectedOption.textContent.split(" - ")[0].trim();

        const products = button.getAttribute('data-products').split(',');
        const planMapScript = bundleCard.querySelector('.selling-plan-map');

        const planMap = planMapScript ? JSON.parse(planMapScript.textContent) : {};

        const cartItems = products
            .map((variantId) => {
                const variantInfo = planMap[variantId];
                const isAvailable = variantInfo?.available;

                if (!isAvailable) {
                    return null;
                }

                const planId = variantInfo?.[selectedFrequencyLabel] || null;

                return {
                    id: parseInt(variantId, 10),
                    quantity: 1,
                    selling_plan: planId
                };
            })
            .filter(Boolean);

        console.log("Cart items:", cartItems);

        fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: cartItems }),
        })
            .then((response) => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text) });
                }
                return response.json();
            })
            .then(() => {
                console.log('Products added to cart');
                localStorage.setItem('open_cart_drawer', 'true');
                location.reload();
            })
            .catch((error) => {
                console.error('Error adding products to cart:', error);
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('open_cart_drawer') === 'true') {
            setTimeout(() => {
                document.querySelector('.main-sidebar-tool-item a')?.click();
                localStorage.removeItem('open_cart_drawer');
            }, 500);
        }
    });
</script>

{% schema %}
{
  "name": "Product Bundles",
  "settings": [
    {
      "type": "text",
      "id": "bundles_heading",
      "label": "Section Heading",
      "default": "Popular Bundles"
    }
  ],
  "blocks": [
    {
      "type": "bundle",
      "name": "Bundle",
      "settings": [
        {
          "type": "metaobject",
          "label": "Bundle",
          "id": "bundle",
          "metaobject_type": "bundles"
        }
      ]
    }
  ],
  "max_blocks": 4,
  "presets": [
    {
      "name": "Bundles Section",
      "blocks": []
    }
  ]
}
{% endschema %}

